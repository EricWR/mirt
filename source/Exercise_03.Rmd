Exercise 3
========================================================

This exercise requires setting up `multipleGroup()` for estimating multiple-group models, and includes
a DIF search. The data is available in the `Exercise_03.Rdata` file. 

Load the dataset into R using the `load()` function, and inspect the defined objects.
The object named `data` represents a 20-item dichtomously scored test. The `group` object consists of 
two groups: a set of individuals that had been trained in test taking skills (`with_training`) 
and a set of individuals without any training (`without_training`).

```{r setup, include=FALSE}
# set to true to show my answers
showcode <- TRUE
```

### 1) Explore the dataset, and determine the dimensionality with `mirt()` (could be different across groups, but assume that it isn't for now). 

```{r Q1, include=showcode, eval=showcode}
library(mirt)
load('Exercise_03.Rdata')
table(group)
head(data)

mod1 <- mirt(data, 1)
mod2 <- mirt(data, 2)
anova(mod1, mod2) #unidimensional appears to be fine
```

### 2) Use `itemfit()` to determine if there are any aberrant items in the unidimensional model according to the S-X2 statistic. Use a false-discovery rate adjustment, such as the Benjamini and Hochberg adjustment, to control for multiple comparisons when inspecting the $p$-values (found in the `p.adjust()` function).

```{r Q2, include=showcode, eval=showcode}
fit <- itemfit(mod1)
fit

#adjust the S-X2 values for false-discovery
p.adjust(fit$p.S_X2, method = 'fdr')
```

### 3) Fit a completely independent multiple group model to the data with `multipleGroup()`, as well as the completely equal model, and view the estimated coefficients. Plot the independent model's test score and information plots (`type = 'score'` and `'info'`), and plot a few items tracelines with `itemplot()`. 

```{r Q3, include=showcode, eval=showcode}
#completely independent
mod.ind <- multipleGroup(data, 1, group=group)
coef(mod.ind)

#completely equal
mod.equal <- multipleGroup(data, 1, group=group, invariance = c('slopes', 'intercepts'))
coef(mod.equal)

plot(mod.ind)
plot(mod.ind, type = 'score')

itemplot(mod.ind, 1)
itemplot(mod.ind, 2)
itemplot(mod.ind, 3)
```

### 4) The items appear to be behaving differently for each group, which is an indication that there are either population difference between the groups, the items are showing DIF, or both. There are two ways to go about testing group differences: constrain parameters from the independent model (above) and determine if these constraints make the model fit worse, or free parameters in the fully equal model to determine if the fit improves. We will use the latter approach. 

### Fit a less constrained versions of the completely equal model where the mean and variance for the second group is freed, but intercepts and slopes are still constrained to be equal. Hint: See the `invariance = ''` argument in `?multipleGroup`. Compare these models to determine if group differences exist. 

```{r Q4, include=showcode, eval=showcode}
mod.freegroup <- multipleGroup(data, 1, group=group, 
                      invariance = c('intercepts','slopes', 'free_means', 'free_varcov'))
#MUCH better fit with differing group parameters
anova(mod.freegroup, mod.equal)

#group with training appears to have a higher group mean, but with more variance
coef(mod.freegroup)[[2]]$GroupPars
```

### 5) Check to see if the newly acquired model still fits worse than the independent model (it should, but not by much). A difference between the independent and group freed model likely indicates that over and above group differences there may be items that are not functioning the same within each group (DIF). In this case some items may have different slopes, intercepts, or both.

### Begin a DIF search by forming a `for(i in 1:ncol(data))` loop, and free each slope and intercept for each item independently (see the examples in `?multipleGroup` for a demonstration). Compare each one of these models to the model with the freed group parameters (each test should have 2 degrees of freedom).

```{r Q5, include=showcode, eval=showcode}
#information stats pretty close now, but still fits worse than independent model
anova(mod.freegroup, mod.ind) 

#dif search
estmodels <- vector('list', ncol(data))
itemnames <- colnames(data)
for(i in 1:ncol(data))
    estmodels[[i]] <- multipleGroup(data, 1, group = group, verbose = FALSE,
                             invariance=c('free_means', 'free_varcov', 
                             itemnames[-i]))
(anovas <- lapply(estmodels, anova, object2=mod.freegroup))
```

### 6) Your search is now nearly over, but the next part requires some more intense hunting. From 5) you should notice that 3 of the DIF tests were significant at the .001 level, indicating that either the slope, intercept, or both parameters should be kept free across the groups. 

### Using the `mod2values()` function to help you locate the appropriate parameter numbers, manually set up appropriate `constrain` arguments to isolate the parameters of interest to locate which parameters are showing DIF. Hint: in total there are 3 parameters showing DIF. 

```{r Q6, include=showcode, eval=showcode}
(vals <- mod2values(mod.freegroup))
#View(vals)

#item 2
freeint.2 <- multipleGroup(data, 1, group=group, 
                             invariance = c('free_means', 'free_varcov', itemnames[-2]), 
                             constrain = list(c(5, 87)))
freeslope.2 <- multipleGroup(data, 1, group=group, 
                           invariance = c('free_means', 'free_varcov', itemnames[-2]),
                           constrain = list(c(6, 88)))
anova(freeslope.2, mod.freegroup) #freeing slope is highly significant
anova(freeint.2, mod.freegroup)
itemplot(freeslope.2, 2)

#item 3
freeint.3 <- multipleGroup(data, 1, group=group, 
                             invariance = c('free_means', 'free_varcov', itemnames[-3]), 
                             constrain = list(c(9, 91)))
freeslope.3 <- multipleGroup(data, 1, group=group, 
                           invariance = c('free_means', 'free_varcov', itemnames[-3]),
                           constrain = list(c(10, 92)))
anova(freeslope.3, mod.freegroup) #freeing slope highly sign
anova(freeint.3, mod.freegroup)
itemplot(freeslope.3, 3)

#item 19
freeint.19 <- multipleGroup(data, 1, group=group, 
                             invariance = c('free_means', 'free_varcov', itemnames[-19]), 
                             constrain = list(c(73, 155)))
freeslope.19 <- multipleGroup(data, 1, group=group, 
                           invariance = c('free_means', 'free_varcov', itemnames[-19]),
                           constrain = list(c(74, 156)))
anova(freeslope.19, mod.freegroup) 
anova(freeint.19, mod.freegroup) #freeing intercept is highly significant
itemplot(freeint.19, 19)
```

```{r Q6b, include=showcode, eval=showcode, tidy=FALSE}
#as of version 1.0, constrains can be specified for each item with mirt.model

#item 2
freeintmod.2 <- mirt.model('F = 1-20
                         CONSTRAINB = (1-20, a1), (1, 3-20, d)')
freeslopemod.2 <- mirt.model('F = 1-20
                         CONSTRAINB = (1, 3-20, a1), (1-20, d)')
freeint.2 <- multipleGroup(data, freeintmod.2, group=group, 
                             invariance = c('free_means', 'free_varcov'))
freeslope.2 <- multipleGroup(data, freeslopemod.2, group=group, 
                           invariance = c('free_means', 'free_varcov'))
anova(freeslope.2, mod.freegroup) #freeing slope is highly significant
anova(freeint.2, mod.freegroup)
itemplot(freeslope.2, 2)

#item 3
freeintmod.3 <- mirt.model('F = 1-20
                         CONSTRAINB = (1-20, a1), (1,2,4-20, d)')
freeslopemod.3 <- mirt.model('F = 1-20
                         CONSTRAINB = (1,2,4-20, a1), (1-20, d)')
freeint.3 <- multipleGroup(data, freeintmod.3, group=group, 
                             invariance = c('free_means', 'free_varcov'))
freeslope.3 <- multipleGroup(data, freeslopemod.3, group=group, 
                           invariance = c('free_means', 'free_varcov'))
anova(freeslope.3, mod.freegroup) #freeing slope highly sig
anova(freeint.3, mod.freegroup)
itemplot(freeslope.3, 3)

#item 19
freeintmod.19 <- mirt.model('F = 1-20
                         CONSTRAINB = (1-20, a1), (1-18, 20, d)')
freeslopemod.19 <- mirt.model('F = 1-20
                         CONSTRAINB = (1-18,20, a1), (1-20, d)')
freeint.19 <- multipleGroup(data, freeintmod.19 , group=group, 
                             invariance = c('free_means', 'free_varcov'))
freeslope.19 <- multipleGroup(data, freeslopemod.19, group=group, 
                           invariance = c('free_means', 'free_varcov'))
anova(freeslope.19, mod.freegroup) 
anova(freeint.19, mod.freegroup) #freeing intercept is highly significant
itemplot(freeint.19, 19)
```

### 7) From question 6, how does this model compare to the completely independent model? If the final model has better information criteria than the completely independent model then compute EAP factor scores for the groups with `fscores()`, returning only the scores for each individual in the dataset.

```{r Q7, include=showcode, eval=showcode, tidy=FALSE}
#final model
final <- multipleGroup(data, 1, group=group, 
                           invariance = c('free_means', 'free_varcov', itemnames[-c(2,3,19)]),
                           constrain = list(c(6, 88), c(10, 92), c(73, 155)))

#...or using mirt.model syntax
finalmod <- mirt.model('F = 1-20
                       CONSTRAINB = (1,4-20, a1), (1-18,20, d)')
final <- multipleGroup(data, finalmod, group=group, 
                           invariance = c('free_means', 'free_varcov'))

anova(final, mod.ind) #all information criteria higher

scores <- fscores(final, full.scores = TRUE)
head(scores)
```
