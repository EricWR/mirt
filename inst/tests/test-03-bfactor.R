context('bfactor')

test_that('dich data', {
    key <- c(1,4,5,2,3,1,2,1,3,1,2,4,2,1,5,3,4,4,1,4,3,3,4,1,3,5,1,3,1,5,4,5)
    data <- key2binary(SAT12, key)
    specific <- c(2,3,2,3,3,2,1,2,1,1,1,3,1,3,1,2,1,1,3,3,1,1,3,1,3,3,1,3,2,3,1,2)
    mod1 <- bfactor(data, specific, verbose=FALSE, SE = TRUE, SE.type = 'crossprod')
    expect_is(mod1, 'ConfirmatoryClass')
    expect_equal(mod1@df, 4294967199)
    cfs <- do.call(c, coef(mod1, digits=4))
    cfs <- as.numeric(na.omit(cfs[cfs != 0 & cfs != 1]))
    expect_equal(cfs, c(0.7865, 0.5162, 1.0568, 0.444, 0.0104, 0.8776, -1.0732, -1.3119, -0.8345, 1.4914, 1.0661, 1.9167, 0.8126, 0.3019, 1.3233, 0.471, 0.1911, 0.751, 1.1478, 0.8265, 1.4691, -0.1527, -0.5599, 0.2545, -1.1728, -1.4364, -0.9093, 0.5281, 0.2963, 0.76, 0.5815, 0.1565, 1.0064, -0.5575, -0.7687, -0.3464, 0.9683, 0.6685, 1.2682, 0.5127, 0.0959, 0.9296, 0.6283, 0.3893, 0.8672, 1.14, 0.8051, 1.4749, 0.5845, 0.0235, 1.1455, -2.1296, -2.5198, -1.7394, 1.0358, 0.6506, 1.4211, 0.9598, 0.3295, 1.59, 1.5646, 1.1836, 1.9456, 0.6732, 0.3994, 0.9469, 0.5252, 0.0134, 1.037, -1.5704, -1.8553, -1.2854, 0.4447, 0.0496, 0.8398, 1.0579, 0.2177, 1.8981, 2.4887, 1.8598, 3.1176, 1.035, 0.7049, 1.3651, 0.7927, 0.2812, 1.3042, -0.4015, -0.6407, -0.1622, 1.5789, 0.1503, 3.0075, 0.8656, -0.9266, 2.6578, 5.4048, 3.4376, 7.3721, 0.1227, -0.0916, 0.337, 0.2718, -0.0671, 0.6106, -0.3507, -0.5323, -0.1692, 1.0941, 0.7489, 1.4392, 0.5933, 0.1307, 1.056, 0.8849, 0.6291, 1.1407, 1.0922, 0.6933, 1.4911, 1.0331, 0.4239, 1.6423, 1.3608, 1.0082, 1.7135, 1.3253, 0.9007, 1.7498, 0.5816, 0.0532, 1.1101, 2.0185, 1.6309, 2.406, 0.738, 0.4797, 0.9963, 0.3918, 0.0052, 0.7785, -0.3909, -0.5968, -0.185, 1.5193, 0.7708, 2.2678, 0.3175, -0.5343, 1.1693, 4.1839, 3.3306, 5.0372, 1.7573, 1.3187, 2.1958, 0.1942, -0.3433, 0.7316, -0.8748, -1.165, -0.5845, 0.8655, 0.5791, 1.1518, 0.031, -0.312, 0.3741, 0.2388, 0.0304, 0.4473, 1.5344, 0.9815, 2.0874, 0.4074, -0.1467, 0.9614, 2.6508, 2.1189, 3.1828, 0.5231, 0.0768, 0.9695, 0.6856, -0.1112, 1.4824, 2.6642, 2.1592, 3.1692, 1.6702, 0.8634, 2.4771, -0.0199, -0.7249, 0.685, 3.611, 2.7749, 4.4471, 0.6095, 0.366, 0.853, 0.4928, 0.0836, 0.9019, -0.8813, -1.1072, -0.6555, 1.2295, 0.85, 1.609, 0.253, -0.1438, 0.6499, 1.2881, 1.0022, 1.5739, 0.7364, 0.477, 0.9958, 0.6405, 0.2117, 1.0693, -0.5994, -0.8246, -0.3741, 1.491, 1.1, 1.882, 0.4833, 0.0435, 0.9231, -0.1725, -0.4279, 0.0828, 1.9042, 1.306, 2.5024, 0.4201, -0.1637, 1.0039, 2.8061, 2.2376, 3.3746, 1.0578, 0.7614, 1.3542, 0.1475, -0.2384, 0.5334, 0.1725, -0.0414, 0.3863, 1.2209, 0.0695, 2.3722, 2.0176, -1.0565, 5.0917, -1.1744, -2.2709, -0.0779, 0.4348, 0.195, 0.6746, -0.1751, -0.5294, 0.1792, -0.2521, -0.4384, -0.0658, 2.5747, 1.5548, 3.5945, -0.2187, -0.8881, 0.4506, 2.9873, 2.0736, 3.901, 0.1327, -0.1186, 0.3839, 0.0297, -0.3723, 0.4317, -1.6521, -1.8929, -1.4113),
                 tolerance = 1e-2)
    fs <- fscores(mod1, verbose = FALSE)
    expect_is(fs, 'matrix')
    expect_true(mirt:::closeEnough(fs[1:6,'F1'] - c(-0.60722529, -0.07509667, -1.91232286,
                                                    -1.99377222, -2.00032222, -1.90825978), -1e-2, 1e-2))
    cof <- coef(mod1, verbose = FALSE)
    expect_is(cof, 'list')
    sum <- summary(mod1, verbose = FALSE)
    expect_is(sum, 'list')
#     fit <- fitIndices(mod1)
#     expect_equal(fit$M2, 6772.915, tolerance = 1e-2)
#     expect_equal(fit$df.M2, 432, tolerance = 1e-2)
    pfit1 <- personfit(mod1)
    expect_is(pfit1, 'data.frame')
    ifit <- itemfit(mod1)
    expect_is(ifit, 'data.frame')
    
    #nestlogit
    scoredSAT12 <- data
    scoredSAT12[,1:5] <- as.matrix(SAT12[,1:5])
    nestmod <- mirt(scoredSAT12, 1, c(rep('2PLNRM',5),rep('2PL', 27)), key=key, verbose=FALSE)
    cfs <- as.numeric(do.call(c, coef(nestmod, digits=4)))
    cfs <- cfs[cfs != 0 & cfs != 1]
    expect_equal(cfs, c(0.7928, -1.0428, -0.5715, -0.5787, -3.1137, 1.4113, 0.2128, 0.07, -5.4259, -5.7802, 1.5217, 0.4431, -0.919, -0.4077, -0.2366, -1.6949, -2.9472, -1.3499, -0.6444, -6.4068, 1.063, -1.1381, 0.1255, -0.1845, -0.3254, -0.2015, 0.1254, 0.4052, -0.6207, -2.5713, 0.5877, -0.5306, 0.0333, -0.0066, 0.1137, -1.1324, -0.0994, 0.0382, -0.2306, -3.6532, 0.983, 0.605, 0.4158, 0.0505, -0.0696, -1.3233, 0.6194, 0.0295, -0.7007, -5.3263, 1.1315, -2.04, 1.0201, 1.3905, 0.7031, -1.5122, 0.5175, 2.1378, 0.9976, -0.3594, 1.7057, 5.2077, 0.1694, -0.3456, 1.0861, 0.847, 1.0424, 1.177, 1.327, 1.9449, 0.7268, -0.3816, 1.4883, 4.0989, 1.6847, -0.8479, 0.8226, 0.2359, 1.5806, 2.6433, 0.6012, 2.5153, 1.5424, 3.4789, 0.649, -0.8519, 1.2108, 1.2726, 0.7751, -0.567, 1.5423, -0.17, 1.8603, 2.7282, 1.076, 0.1748, 0.8315, -0.7493, 0.3816, -0.2479, 2.3798, 2.8218, 0.1269, -1.6513),
                 tolerance = 1e-2)
    expect_equal(nestmod@logLik, -11715.17, tolerance = 1e-4)

    #simulate data
    set.seed(1234)
    a <- matrix(c(
        1,0.5,NA,
        1,0.5,NA,
        1,0.5,NA,
        1,0.5,NA,
        1,0.5,NA,
        1,0.5,NA,
        1,0.5,NA,
        1,NA,0.5,
        1,NA,0.5,
        1,NA,0.5,
        1,NA,0.5,
        1,NA,0.5,
        1,NA,0.5,
        1,NA,0.5),ncol=3,byrow=TRUE)

    d <- matrix(c(
        -1.0,NA,NA,
        -1.5,NA,NA,
        1.5,NA,NA,
        0.0,NA,NA,
        0.0,-1.0,1.5,
        0.0,2.0,-0.5,
        3.0,2.0,-0.5,
        3.0,2.0,-0.5,
        2.5,1.0,-1,
        2.0,0.0,NA,
        -1.0,NA,NA,
        -1.5,NA,NA,
        1.5,NA,NA,
        0.0,NA,NA),ncol=3,byrow=TRUE)

    nominal <- matrix(NA, nrow(d), ncol(d))
    nominal[5, ] <- c(0,1.2,2)
    sigma <- diag(3)
    set.seed(1234)
    items <- itemtype <- c(rep('dich', 4), 'nominal', 'gpcm', rep('graded',4),rep('dich', 4))
    dataset <- simdata(a,d,3000,itemtype, sigma=sigma, nominal=nominal)

    specific <- c(rep(1,7),rep(2,7))
    items[items == 'dich'] <- '2PL'
    simmod <- suppressMessages(bfactor(dataset, specific, itemtype = items, verbose=FALSE))
    expect_is(simmod, 'ConfirmatoryClass')
    expect_equal(simmod@df, 442315)
    cfs <- as.numeric(do.call(c, coef(simmod, digits=4)))
    cfs <- cfs[cfs != 0 & cfs != 1]
    expect_equal(cfs, c(1.1041, 0.08, -1.0015, 1.1639, -0.5016, -1.5207, 1.1132, 0.6341, 1.6349, 0.9834, 0.0885, 0.0694, 1.1464, 0.2551, 1.1043, 2, -0.9361, 1.5983, 1.1543, -0.1421, 2, 2.0817, -0.4029, 1.1246, 0.0932, 3.0943, 2.0269, -0.4557, 0.9981, 0.6139, 3.0811, 2.0627, -0.4541, 0.8432, 0.6361, 2.4515, 0.9724, -0.9835, 1.018, 0.5648, 2.0248, -0.0309, 0.8408, 0.7581, -1.0135, 0.9375, 0.5238, -1.3633, 0.8808, 0.4932, 1.5456, 0.951, 0.7649, 0.0282),
                 tolerance = 1e-2)
    specific[1] <- NA
    simmod2 <- suppressMessages(bfactor(dataset, specific, itemtype = items, verbose=FALSE))
    expect_is(simmod2, 'ConfirmatoryClass')
    expect_equal(simmod2@df, 442316)
    cfs <- as.numeric(do.call(c, coef(simmod2, digits=4)))
    cfs <- cfs[cfs != 0 & cfs != 1]
    expect_equal(cfs, c(1.1073, -1.0015, 1.153, -0.5001, -1.5158, 1.1239, 0.6421, 1.6415, 0.9848, 0.0714, 0.0694, 1.15, 0.2443, 1.1028, 2, -0.9349, 1.5996, 1.1502, -0.1402, 2, 2.0788, -0.4023, 1.1264, 0.0702, 3.0944, 2.027, -0.4557, 0.997, 0.6156, 3.0811, 2.0627, -0.454, 0.8424, 0.6371, 2.4515, 0.9724, -0.9835, 1.0168, 0.5666, 2.0248, -0.0308, 0.8398, 0.7591, -1.0135, 0.938, 0.5235, -1.3634, 0.8795, 0.4952, 1.5456, 0.9501, 0.7663, 0.0282),
                 tolerance = 1e-2)
    fs <- fscores(simmod, verbose = FALSE)
    expect_true(mirt:::closeEnough(fs[1:6,'F1'] - c(-2.713717, -2.440282, -2.177029,
                                                    -2.265682, -2.249449, -2.416284), -1e-2, 1e-2))
    expect_is(fs, 'matrix')

    res <- residuals(simmod, verbose = FALSE)
    expect_is(res, 'matrix')
    sum <- summary(simmod, verbose = FALSE)
    expect_is(sum, 'list')

    #two-tier
    set.seed(1234)
    a <- matrix(c(
        0,1,0.5,NA,NA,
        0,1,0.5,NA,NA,
        0,1,0.5,NA,NA,
        0,1,0.5,NA,NA,
        0,1,0.5,NA,NA,
        0,1,NA,0.5,NA,
        0,1,NA,0.5,NA,
        0,1,NA,0.5,NA,
        1,0,NA,0.5,NA,
        1,0,NA,0.5,NA,
        1,0,NA,0.5,NA,
        1,0,NA,NA,0.5,
        1,0,NA,NA,0.5,
        1,0,NA,NA,0.5,
        1,0,NA,NA,0.5,
        1,0,NA,NA,0.5),ncol=5,byrow=TRUE)
    
    d <- matrix(rnorm(16))
    items <- rep('dich', 16)
    
    sigma <- diag(5)
    sigma[1,2] <- sigma[2,1] <- .7
    dataset <- simdata(a,d,2000,itemtype=items,sigma=sigma)
    
    specific <- c(rep(1,5),rep(2,6),rep(3,5))
    model <- mirt.model('
        G1 = 1-8
        G2 = 9-16
        COV = G1*G2')
    
    simmod <- bfactor(dataset, specific, model, quadpts = 9, TOL = 1e-3, verbose=FALSE)
    expect_is(simmod, 'ConfirmatoryClass')
    expect_equal(simmod@df, 65486)
    cfs <- as.numeric(do.call(c, coef(simmod, digits=4)))
    cfs <- cfs[cfs != 0 & cfs != 1]
    expect_equal(cfs, c(1.0514, 0.2561, -1.1352, 1.0891, -0.3281, 0.341, 1.2334, 0.6502, 1.0916, 0.9595, -0.3436, -2.251, 1.1298, 0.3025, 0.394, 0.9172, 0.7891, 0.4861, 0.7857, 0.7017, -0.5421, 0.8105, 0.9005, -0.6151, 1.0417, 0.3254, -0.5301, 0.9779, 0.5754, -0.8781, 0.9959, 0.5226, -0.4473, 1.0382, 0.5791, -0.993, 0.9999, 0.1955, -0.78, 1.0306, 0.2133, 0.0199, 1.0225, 0.5045, 0.9158, 0.9605, 0.4099, -0.0464, 0.6462),
                 tolerance = 1e-2)
    fs <- fscores(simmod, scores.only=T, returnER=TRUE)
    expect_equal(as.numeric(fs), c( 0.7548380, 0.7650391, 0.1780756, 0.4053908, 0.1790225), tolerance = 1e-2)
})
